<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>HelpHub</title>
    <link rel="stylesheet" href="./styleListBenscopy.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<nav>
    <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom fixed-top">
        <svg class="bi me-2" width="40" height="78">
            <use xlink:href="#bootstrap" />
        </svg>
        <a href="../index.html"
            class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
            <span class="help">
                <img src="help white.png" alt="HelpHub Logo" class="logo">
            </span>
        </a>

        <ul class="nav nav-pills">
            <li class="nav-item"><a href="../index.html" class="nav-link">Home</a></li>
            <li class="nav-item"><a href="listvols.html" class="nav-link">Helpers</a></li>
            <li class="nav-item"><a href="listbens.html" class="nav-link">Helpees</a></li>
            <li class="nav-item"><a href="../services.html" class="nav-link">Services</a></li>
            <li class="nav-item"><a href="../about.html" class="nav-link">About</a></li>
        </ul>
    </header>
    </div>
</nav>

<body>
    <div class="container">
        <div class="button-container">
            <button class="filter-button" data-filter="Cooking">Cooking</button>
            <button class="filter-button" data-filter="Maintenance">Maintenance</button>
            <button class="filter-button" data-filter="Transport">Transport</button>
            <button class="filter-button" data-filter="Help with shopping">Help with shopping</button>
            <button class="filter-button" data-filter="Caring">Caring</button>
        </div>
        <div id="container-swipe" class="container-swipe">
        <button class="nav-button prev-button" id="prev-button"><i class="fas fa-chevron-left"></i></button>
        <div class="slider-wrapper" id="cards">
            <!-- Os cards serão inseridos aqui -->
        </div>
        <button class="nav-button next-button" id="next-button"><i class="fas fa-chevron-right"></i></button>
        </div>

    </div>
    <div id="map"></div>
    <script>
        let allBens = [];
        let currentPosition = 0;
        const cardsWrapper = document.getElementById("cards");
        const prevButton = document.getElementById("prev-button");
        const nextButton = document.getElementById("next-button");
        const cardWidth = 300 + 15; //card width + margin right;
        const cardsPerPage = 3;

        window.onload = function () {
          resetList();

          const filterButtons = document.querySelectorAll('.filter-button');
          filterButtons.forEach(button => {
            button.addEventListener('click', function () {
              const filter = this.getAttribute('data-filter');
              filterList(filter);
            });
          });
          prevButton.addEventListener('click', slidePrev);
          nextButton.addEventListener('click', slideNext);
        }

        function resetList() {
            const API_URL = "http://localhost:8080/finalProject/api/ben";
            fetch(API_URL)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((bens) => {
                    allBens = bens;
                    populateTable(bens);
                })
                .catch((error) => {
                    console.error("Erro ao carregar dados:", error);
                });
        }

      function populateTable(bens) {
        cardsWrapper.innerHTML = "";
        bens.forEach((ben) => {
          const cardHTML = `
              <div class="card-container card-item" data-ben-id="${ben.id}">
                  <img src="servicesImages/shopping-cart.jpg" alt="User Image" class="user-image">
                  <h3 class="service">${ben.services}</h3>
                  <p class="user-name">${ben.firstName + " " + ben.lastName}</p>
                  <p class="description">${ben.description}</p>
                  <div class="button-container-card">
                    <button class="message-button">Map</button>
                    <button class="contact-button">Contact</button>
                  </div>
                  <div class="map-card-item" data-ben-id="${ben.id}" style="display:none;">
                      <div id="map-${ben.id}" class="map-container"></div>
                    </div>
                </div>
          `;
          cardsWrapper.innerHTML += cardHTML;
        });

            cardsWrapper.addEventListener("click", function (event) {
              if (event.target && event.target.classList.contains("message-button")) {
                  const cardItem = event.target.closest(".card-item");
                  const benId = cardItem.dataset.benId;
                  const ben = allBens.find((b) => b.id == benId);
                  if (ben) {
                      showMap(ben);
                  }
              }
              if (event.target && event.target.classList.contains("contact-button")) {
                  const cardItem = event.target.closest(".card-item");
                  const benId = cardItem.dataset.benId;
                  const ben = allBens.find((b) => b.id == benId);
                  if (ben) {
                    showContactInfo(ben);
                  }
              }
            });
      }


        let mapsApiPromise = null;

        function loadGoogleMapsAPI() {
            if (mapsApiPromise) {
                return mapsApiPromise;
            }
            mapsApiPromise = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const map = document.createElement('map');
                script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyC-9u6fShAlbITdTBfm0LrAZUdwphF5P_g`;
                script.async = true;
                script.defer = true;
                script.onerror = (err) => {
                    reject(err);
                };
                script.onload = () => {
                    resolve(google.maps);
                }
                document.body.appendChild(script);
            });
            return mapsApiPromise
        }

        function filterList(filter) {
          const filteredBens = allBens.filter(ben => ben.services === filter);
          populateTable(filteredBens);
        }

       function slideNext() {

           const totalWidth = cardsWrapper.scrollWidth;
            const maxPosition= totalWidth-cardsWrapper.offsetWidth;

         if (currentPosition <= maxPosition) {
            currentPosition += cardWidth * cardsPerPage;
               if(currentPosition>maxPosition){
                   currentPosition=maxPosition;
               }
             cardsWrapper.style.transform = `translateX(-${currentPosition}px)`;
         }

        }
        function slidePrev() {
            const maxPosition = 0;
             if (currentPosition > maxPosition ) {
                 currentPosition -= cardWidth * cardsPerPage;
                  if(currentPosition<maxPosition){
                   currentPosition=maxPosition;
               }
                 cardsWrapper.style.transform = `translateX(-${currentPosition}px)`;
             }
        }

        async function showMap(ben) {
            try {
                const maps = await loadGoogleMapsAPI();
                const address = ben.address;
                const geocoder = new maps.Geocoder();

                const results = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === "OK") {
                            resolve(results);
                        } else {
                            reject(status);
                        }
                    });
                });

                if (results && results.length > 0) {
                    const latitude = results[0].geometry.location.lat();
                    const longitude = results[0].geometry.location.lng();

                    const mapContainer = document.getElementById(`map-${ben.id}`);
                    const mapCard = mapContainer.closest(".map-card-item");
                    mapCard.style.display = "inline";

                    const map = new maps.Map(mapContainer, {
                        center: { lat: latitude, lng: longitude },
                        zoom: 15,
                    });
                    new maps.Marker({
                        position: { lat: latitude, lng: longitude },
                        map: map,
                    });
                } else {
                    alert(`Não foi possível encontrar o mapa para o endereço fornecido: ${address}, erro no results do geocoding`);
                }
            } catch (error) {
                if (error instanceof Error) {
                    console.error("error loading google maps: ", error);
                    alert("An error has occurred while loading google maps please try again later");
                } else {
                    console.error("Geocoding error:", error);
                    let errorMessage = `Não foi possível encontrar o mapa para o endereço fornecido: ${address}. `;
                    switch (error) {
                        case "ZERO_RESULTS":
                            errorMessage += "Não foi encontrado nenhum resultado para o endereço fornecido.";
                            break;
                        case "OVER_QUERY_LIMIT":
                            errorMessage += "O limite de requisições do geocoding foi alcançado. Tente novamente mais tarde.";
                            break;
                        case "REQUEST_DENIED":
                            errorMessage += "Sua requisição de geocoding foi negada. Verifique a chave da api.";
                            break;
                        case "INVALID_REQUEST":
                            errorMessage += "A requisição de geocoding está inválida.";
                            break;
                        case "UNKNOWN_ERROR":
                            errorMessage += "Ocorreu um erro desconhecido com o serviço de geocoding. Tente novamente mais tarde.";
                            break;
                        default:
                            errorMessage += "Erro desconhecido.";
                    }
                    alert(errorMessage);
                }
            }
        }

        function showContactInfo(ben) {
            alert(`Name: ${ben.firstName} ${ben.lastName}\nPhone: ${ben.phone}\nAddress: ${ben.address}\nEmail: ${ben.email}`);
        }
    </script>
</body>
<footer></footer>
</html>